{% extends 'base.html.twig' %}

{% block breadcrumbs %}
    <li>
        <a href="{{ path('homepage') }}">Home</a>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <a href="{{ path('student_list') }}">Students</a>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span>{{ student.studentId }}</span>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span>Observations</span>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span>List</span>
    </li>
{% endblock %}

{% block pageTitle %}
    Observations
{% endblock %}

{% block title %}
    {{ title }}
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('theme/assets/global/plugins/datatables/datatables.min.css') }}">
    <link rel="stylesheet"
          href="{{ asset('theme/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css') }}">
{% endblock %}

{% block body %}
    {% for flashMessage in app.session.flashbag.get('success') %}
        <div class="alert alert-success">
            {{ flashMessage }}
        </div>
    {% endfor %}


    <div class="row">
        <div class="col-md-12">
            <!-- BEGIN EXAMPLE TABLE PORTLET-->
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption font-dark">
                        <i class="icon-settings font-dark"></i>
                        <span class="caption-subject bold uppercase"> List </span>
                    </div>
                    <div class="actions">
                        <a id="add-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-plus"></i>
                        </a>
                        <a id="enable-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-power-off"></i>
                        </a>
                        <a id="data-analysis-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-calendar"></i>
                        </a>
                        <a id="phase-list-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-list-ol"></i>
                        </a>
                        <a id="edit-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-edit"></i>
                        </a>
                        <a id="delete-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-trash"></i>
                        </a>
                        <a id="download-button" class="btn btn-circle btn-icon-only btn-default" href="javascript:;">
                            <i class="fa fa-download"></i>
                        </a>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-striped table-bordered table-hover table-checkable order-column"
                           id="observation-datatable">
                        <thead>
                        <tr>
                            <th>
                                <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                    <input type="checkbox" class="group-checkable" data-set="#observation-datatable .checkboxes"/>
                                    <span></span>
                                </label>
                            </th>
                            <th> Name</th>
                            <th> Description</th>
                            <th> Enabled</th>
                            <th> Observer</th>
                            <th> Categorized data</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for record in records %}
                            <tr class="odd gradeX">
                                <td>
                                    <label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                        <input type="checkbox" class="checkboxes" value="{{ record.id }}"/>
                                        <span></span>
                                    </label>
                                </td>
                                <td> {{ record.name }} </td>
                                <td>
                                    {{ record.description }}
                                </td>
                                <td>
                                    {% if(record.isEnabled == '1') %}
                                        {% set classname = 'label-success' %}
                                    {% else %}
                                        {% set classname = 'label-warning' %}
                                    {% endif %}
                                    <span class="label label-sm {{ classname }}">
                                {{ record.slugIsEnabled }}
                            </span>
                                </td>
                                <td>{{ record.observerUsername }}</td>
                                <td>
                                    {% set numberOfObservations = render(controller(
                                    'App\\Controller\\ObservationController::numberAction',
                                    { 'id': record.id }
                                    )) %}

                                    {% set percentage = (numberOfObservations != 0) ?
                                    record.countCategorizedData / numberOfObservations * 100 :
                                    0
                                    %}

                                    <div class="dashboard-stat2">
                                        <div class="progress-info">
                                            <div class="status">
                                                <div class="status-title"> 0 </div>
                                                <div class="status-number"> {{ percentage }}% ({{ record.CountCategorizedData }}/{{ numberOfObservations }})</div>
                                            </div>

                                            <div class="progress">
                                                <span style="width: {{ percentage }}%; background-color: #36c6d3" class="progress-bar progress-bar-success">
                                                    <span class="sr-only">{{ percentage }}% change</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>



                                    <!--
                                    <div class="row">
                                        <div class="dashboard-stat2">
                                            <div class="display">
                                                <div class="number">
                                                    <h3 class="font-blue-sharp">
                                                        {% set numberOfObservations = render(controller(
                                                            'App\\Controller\\ObservationController::numberAction',
                                                            { 'id': record.id }
                                                        )) %}

                                                        {% set percentage = (numberOfObservations != 0) ?
                                                        record.countCategorizedData / numberOfObservations * 100 :
                                                        0
                                                        %}

                                                        <span data-counter="counterup" data-value="{{ numberOfObservations }}">
                                                            {{ record.countCategorizedData }} / {{ numberOfObservations }}
                                                        </span>
                                                    </h3>
                                                </div>
                                            </div>
                                            <div class="progress-info">
                                                <div class="progress">
                                                <span style="width: {{ percentage }}%;" class="progress-bar progress-bar-success blue-sharp">
                                                    <span class="sr-only">{{ percentage }}% change</span>
                                                </span>
                                                </div>
                                                <div class="status">
                                                    <div class="status-title"> 0 </div>
                                                    <div class="status-number"> {{ percentage }}% </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>-->
                                </td>
                            </tr>
                        {% endfor %}

                        </tbody>
                    </table>


                </div>
            </div>
            <!-- END EXAMPLE TABLE PORTLET-->

            <div class="modal fade" id="basic" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title">Warning</h4>
                        </div>
                        <div class="modal-body"> Are you sure you want to delete this observation?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn dark btn-outline" data-dismiss="modal">Close</button>
                            <button id="confirm-delete" type="button" class="btn red" data-url="">Yes, delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{ asset('theme/assets/global/plugins/datatables/datatables.min.js') }}"></script>
    <script src="{{ asset('theme/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js') }}"></script>
    <script src="{{ asset('theme/assets/pages/scripts/table-datatables-managed.js') }}"></script>
    <script src="{{ asset('theme/assets/global/plugins/jquery-bootpag/jquery.bootpag.min.js') }}"></script>
    <script src="{{ asset('theme/assets/pages/scripts/ui-general.min.js') }}"></script>

    <script>
        $( document ).ready(function() {
            $('#edit-button').addClass('opaque');
            $('#delete-button').addClass('opaque');
            $('#data-analysis-button').addClass('opaque');
            $('#enable-button').addClass('opaque');
            $('#download-button').addClass('opaque');
            $('#phase-list-button').addClass('opaque');
        });

        $('#add-button').on('click', function(){
            if(!$(this).hasClass('opaque')) {
                location.assign('{{ path('observation_new', { 'id': student.id }) }}');
            }
        });

        $('#edit-button').on('click', function(e){
            e.preventDefault();

            if(!$(this).hasClass('opaque')) {
                location.assign('/observation/edit/' + $("#observation-datatable :checked").val());
            }
        });

        $('#data-analysis-button').on('click', function(){
            if(!$(this).hasClass('opaque')) {
                location.assign('/calendar/' + $("#observation-datatable :checked").val());
            }
        });

        $('#delete-button').on('click', function(e){
            e.preventDefault();

            if(!$(this).hasClass('opaque')) {
                ids = [];

                $('.checkboxes').each(function() {
                    if($(this).is(':checked')) {
                        ids.push($(this).val());
                    }
                });

                if(ids.length > 0) {
                    $('#basic').modal('show');

                    $('#confirm-delete').data('url', '/observation/delete/{{ student.id }}/' + encodeURIComponent(JSON.stringify(ids)));
                }
            }
        });

        $('#confirm-delete').click(function( event ) {
            window.location.href = $('#confirm-delete').data('url');
        });

        $('#enable-button').on('click', function(){
            ids = [];

            $('.checkboxes').each(function() {
                if($(this).is(':checked')) {
                    ids.push($(this).val());
                }
            });

            location.assign('/observation/enableDisable/{{ student.id }}/' + encodeURIComponent(JSON.stringify(ids)));
        });

        $('#download-button').on('click', function() {
            if(!$(this).hasClass('opaque')) {
                location.assign('/observation/download-data/' + $("#observation-datatable :checked").val());
            }
        });

        $('#phase-list-button').on('click', function() {
            if(!$(this).hasClass('opaque')) {
                location.assign('/observation-phase/list/' + $("#observation-datatable :checked").val());
            }
        });

    </script>
{% endblock %}